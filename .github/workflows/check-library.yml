name: Check Library

on:
  pull_request:
    paths:
      - 'library/**'

jobs:
  check-library:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check asset file names
        run: |
          python3 - <<'EOF'
          import os, sys, zlib, subprocess
          found_error = False
          base = os.environ.get('GITHUB_EVENT_PULL_REQUEST_BASE_SHA')
          head = os.environ.get('GITHUB_SHA')
          diff_cmd = f"git diff --name-only {base} {head}"
          changed = subprocess.check_output(diff_cmd, shell=True).decode().splitlines()
          assets = [f for f in changed if '/assets/' in f]
          for file in assets:
              try:
                  with open(file, 'rb') as fh:
                      data = fh.read()
                  crc = zlib.crc32(data)
                  if crc > 0x7fffffff:
                      crc -= 0x100000000
                  size = os.path.getsize(file)
                  expected = f'{crc}_{size}'
                  actual = os.path.basename(file)
                  if actual == expected:
                      print(f'✅ {file}')
                  else:
                      print(f'❌ {file}')
                      found_error = True
              except Exception as e:
                  print(f'❌ {file} (error: {e})')
                  found_error = True
          if found_error:
              print('Found files with inconsistent naming patterns')
              sys.exit(1)
          EOF 