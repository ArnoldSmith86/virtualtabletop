#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { execSync } from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const BASE_BRANCH = 'main';
const OLD_BASE_URL = 'https://virtualtabletop.io';
const NEW_BASE_URL = 'https://test.virtualtabletop.io/PR-2846';

const limitArg = process.argv.find((a, i) => process.argv[i - 1] === '--limit');
const LIMIT = limitArg ? parseInt(limitArg, 10) : null;

function hasAIImagery(attribution) {
  if (!attribution) return false;
  const lower = attribution.toLowerCase();
  return lower.includes('midjourney') ||
         lower.includes('chatgpt') ||
         lower.includes('dall-e') ||
         lower.includes('deepai') ||
         lower.includes('stable diffusion') ||
         lower.includes('artificial intelligence') ||
         lower.includes('ai generated') ||
         (lower.includes('generated by') && (lower.includes('ai') || lower.includes('chatgpt') || lower.includes('midjourney'))) ||
         lower.includes('gemini') ||
         lower.includes('myninja');
}

function getChangedGameFiles() {
  try {
    const output = execSync(`git diff --name-only ${BASE_BRANCH}...HEAD`, { encoding: 'utf8' });
    const files = output.trim().split('\n').filter(f => f.endsWith('.json') && f.includes('library/games/'));
    return files;
  } catch (error) {
    console.error('Error getting changed files:', error.message);
    return [];
  }
}

function getGameFromCommit(gameFile, commit) {
  try {
    const output = execSync(`git show ${commit}:"${gameFile}"`, { encoding: 'utf8' });
    return JSON.parse(output);
  } catch (error) {
    return null;
  }
}

function getGameInfoFromCommit(gameFile, commit) {
  const game = getGameFromCommit(gameFile, commit);
  if (!game) return null;
  return {
    image: game._meta?.info?.image,
    attribution: game._meta?.info?.attribution,
    usesAIImagery: game._meta?.info?.usesAIImagery === true
  };
}

function getChangeList(oldGame, newGame) {
  const changes = [];
  const oldInfo = oldGame?._meta?.info ?? {};
  const newInfo = newGame?._meta?.info ?? {};
  if (oldInfo.image !== newInfo.image) changes.push('library image');
  if (oldInfo.attribution !== newInfo.attribution) changes.push('attribution');
  if (Boolean(oldInfo.usesAIImagery) !== Boolean(newInfo.usesAIImagery)) changes.push('ai-flag');
  const oldNorm = JSON.parse(JSON.stringify(oldGame || {}));
  const newNorm = JSON.parse(JSON.stringify(newGame || {}));
  if (oldNorm._meta?.info) {
    delete oldNorm._meta.info.image;
    delete oldNorm._meta.info.attribution;
    delete oldNorm._meta.info.usesAIImagery;
  }
  if (newNorm._meta?.info) {
    delete newNorm._meta.info.image;
    delete newNorm._meta.info.attribution;
    delete newNorm._meta.info.usesAIImagery;
  }
  if (JSON.stringify(oldNorm) !== JSON.stringify(newNorm)) changes.push('ANYTHING ELSE');
  return changes;
}

function getImageAssetPath(imagePath, gameFile) {
  if (!imagePath || !imagePath.startsWith('/assets/')) return null;
  const assetName = imagePath.replace('/assets/', '');
  const gameDir = path.dirname(gameFile);
  return path.join(gameDir, 'assets', assetName);
}

function getImageSizeFromGit(imagePath, gameFile, commit) {
  if (!imagePath || !imagePath.startsWith('/assets/')) return null;
  const assetName = imagePath.replace('/assets/', '');
  const gameDir = path.dirname(gameFile);
  const gameDirRelative = gameFile.replace(/^library\/games\//, '').replace(/\/[^\/]+\.json$/, '');
  
  try {
    const gitPath = `${commit}:"library/games/${gameDirRelative}/assets/${assetName}"`;
    const output = execSync(`git show ${gitPath} 2>/dev/null | wc -c`, { encoding: 'utf8', stdio: 'pipe' });
    const size = parseInt(output.trim(), 10);
    return size > 0 ? size : null;
  } catch (error) {
    return null;
  }
}

function getImageSize(imagePath) {
  if (!imagePath || !fs.existsSync(imagePath)) return null;
  try {
    const stats = fs.statSync(imagePath);
    return stats.size;
  } catch (error) {
    return null;
  }
}

function getImageDimensions(imagePath) {
  if (!imagePath || !fs.existsSync(imagePath)) return null;
  try {
    const escapedPath = imagePath.replace(/'/g, "'\\''");
    const output = execSync(`python3 -c "from PIL import Image; img = Image.open('${escapedPath}'); print(f'{img.width}x{img.height}')"`, { encoding: 'utf8', stdio: 'pipe' });
    const [width, height] = output.trim().split('x').map(Number);
    if (isNaN(width) || isNaN(height)) return null;
    return { width, height };
  } catch (error) {
    return null;
  }
}

function getImageDimensionsFromGit(imagePath, gameFile, commit) {
  if (!imagePath || !imagePath.startsWith('/assets/')) return null;
  const assetName = imagePath.replace('/assets/', '');
  const gameDir = path.dirname(gameFile);
  const gameDirRelative = gameFile.replace(/^library\/games\//, '').replace(/\/[^\/]+\.json$/, '');
  
  const tempFile = `/tmp/temp_image_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  
  try {
    const gitPath = `${commit}:"library/games/${gameDirRelative}/assets/${assetName}"`;
    execSync(`git show ${gitPath} > "${tempFile}" 2>/dev/null`, { encoding: 'utf8', stdio: 'pipe' });
    
    if (!fs.existsSync(tempFile) || fs.statSync(tempFile).size === 0) {
      if (fs.existsSync(tempFile)) fs.unlinkSync(tempFile);
      return null;
    }
    
    const escapedPath = tempFile.replace(/'/g, "'\\''");
    const output = execSync(`python3 -c "from PIL import Image; img = Image.open('${escapedPath}'); print(f'{img.width}x{img.height}')"`, { encoding: 'utf8', stdio: 'pipe' });
    const [width, height] = output.trim().split('x').map(Number);
    
    fs.unlinkSync(tempFile);
    if (isNaN(width) || isNaN(height)) return null;
    return { width, height };
  } catch (error) {
    try {
      if (fs.existsSync(tempFile)) {
        fs.unlinkSync(tempFile);
      }
    } catch (e) {}
    return null;
  }
}

function getImageId(imagePath) {
  if (!imagePath || !imagePath.startsWith('/assets/')) return null;
  return imagePath.replace('/assets/', '');
}


function formatSize(size) {
  if (!size) return 'N/A';
  if (size < 1024) return `${size}B`;
  if (size < 1024 * 1024) return `${(size / 1024).toFixed(1)}KB`;
  return `${(size / (1024 * 1024)).toFixed(1)}MB`;
}

function escapeHtml(text) {
  if (!text) return '';
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function safeForTemplate(s) {
  if (s == null) return '';
  return String(s).replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
}

function formatResolution(dim) {
  if (!dim || typeof dim.width !== 'number' || typeof dim.height !== 'number') return '';
  return `${dim.width}×${dim.height}`;
}

function generateHTML(games, commits) {
  const { baseCommit, headCommit } = commits || {};
  const SIZE_50K = 50 * 1024;
  const SIZE_100K = 100 * 1024;
  const SIZE_200K = 200 * 1024;
  const getSizeColorClass = (size) => {
    const n = Number(size);
    if (n === 0 || Number.isNaN(n)) return 'size-red';
    if (n < SIZE_50K) return 'size-green';
    if (n < SIZE_100K) return 'size-yellow';
    if (n < SIZE_200K) return 'size-orange';
    return 'size-red';
  };

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Games Image Comparison</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    th {
      background-color: #4a90e2;
      color: white;
      padding: 12px;
      text-align: left;
      border: 1px solid #ddd;
    }
    td {
      padding: 10px;
      border: 1px solid #ddd;
      vertical-align: top;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .game-name {
      font-weight: bold;
      min-width: 150px;
    }
    .image-container {
      text-align: center;
      position: relative;
    }
    .image-container img {
      max-width: 200px;
      max-height: 200px;
      border: 2px solid #ddd;
      cursor: pointer;
    }
    .image-container img:hover {
      border-color: #4a90e2;
    }
    .stats {
      margin-top: 8px;
      font-size: 12px;
    }
    .size-green { color: #28a745; font-weight: bold; }
    .size-yellow { color: #ffc107; font-weight: bold; }
    .size-orange { color: #fd7e14; font-weight: bold; }
    .size-red { color: #dc3545; font-weight: bold; }
    .ai-green { color: #28a745; font-weight: bold; }
    .ai-red { color: #dc3545; font-weight: bold; }
    .square-green { color: #28a745; font-weight: bold; }
    .square-red { color: #dc3545; font-weight: bold; }
    .attribution-tooltip {
      position: fixed;
      left: 20px;
      top: 20px;
      width: 600px;
      max-height: 80vh;
      background: white;
      border: 2px solid #4a90e2;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
      pointer-events: none;
      text-align: left;
    }
    .image-container:hover .attribution-tooltip {
      display: block;
    }
    .attribution-tooltip .title {
      margin: 0 0 8px 0;
      color: #4a90e2;
      font-weight: bold;
    }
    .attribution-tooltip .content {
      word-wrap: break-word;
    }
    .old-column, .new-column {
      width: 40%;
    }
    tr.row-has-other-changes {
      background: #ffcccc !important;
      outline: 4px solid #c00;
      box-shadow: inset 0 0 0 2px #c00;
    }
    tr.row-has-other-changes td {
      background: #ffcccc !important;
      font-weight: bold;
    }
    .change-list {
      font-size: 11px;
      color: #555;
      margin-top: 4px;
      font-weight: normal;
    }
    .change-list.other {
      color: #c00;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Library Games Image Comparison</h1>
  <p>Comparing images changed in this branch vs ${BASE_BRANCH}. Hover an image to see attribution.</p>
  <p><strong>Commits:</strong> ${BASE_BRANCH} <code>${baseCommit || '—'}</code> → HEAD <code>${headCommit || '—'}</code></p>

  <table>
    <thead>
      <tr>
        <th>Game Name</th>
        <th class="old-column">Old Image</th>
        <th class="new-column">New Image</th>
      </tr>
    </thead>
    <tbody>
      ${games.map(game => {
        const oldSizeClass = getSizeColorClass(game.oldSize);
        const newSizeClass = getSizeColorClass(game.newSize);
        const oldResolution = formatResolution(game.oldDimensions);
        const newResolution = formatResolution(game.newDimensions);
        const oldAttributionRaw = safeForTemplate(game.oldAttribution || 'No attribution');
        const newAttributionRaw = safeForTemplate(game.newAttribution || 'No attribution');
        const changeList = game.changes || [];
        const hasOther = changeList.includes('ANYTHING ELSE');
        const rowClass = hasOther ? 'row-has-other-changes' : '';
        const changeListHtml = changeList.length
          ? `<div class="change-list${hasOther ? ' other' : ''}">Changed: ${escapeHtml(changeList.join(', '))}</div>`
          : '';
        return `
        <tr${rowClass ? ` class="${rowClass}"` : ''}>
          <td class="game-name">${escapeHtml(game.name)}${changeListHtml}</td>
          <td class="image-container">
            ${game.oldImageId ? `<img src="${OLD_BASE_URL}/assets/${game.oldImageId}" alt="Old image">` : '<p>No image</p>'}
            ${game.oldImageId ? `
            <div class="stats">
              <div class="${oldSizeClass}">Size: ${formatSize(game.oldSize)}</div>
              <div class="${game.oldIsAI ? 'ai-red' : 'ai-green'}">AI: ${game.oldIsAI ? 'Yes' : 'No'}</div>
              <div class="${game.oldIsSquare ? 'square-green' : 'square-red'}">Square: ${game.oldIsSquare ? 'Yes' : 'No'}${oldResolution ? ' ' + oldResolution : ''}</div>
            </div>` : ''}
            <div class="attribution-tooltip"><span class="title">Old attribution</span><div class="content">${oldAttributionRaw}</div></div>
          </td>
          <td class="image-container">
            ${game.newImageId ? `<img src="${NEW_BASE_URL}/assets/${game.newImageId}" alt="New image">` : '<p>No image</p>'}
            ${game.newImageId ? `
            <div class="stats">
              <div class="${newSizeClass}">Size: ${formatSize(game.newSize)}</div>
              <div class="${game.newIsAI ? 'ai-red' : 'ai-green'}">AI: ${game.newIsAI ? 'Yes' : 'No'}</div>
              <div class="${game.newIsSquare ? 'square-green' : 'square-red'}">Square: ${game.newIsSquare ? 'Yes' : 'No'}${newResolution ? ' ' + newResolution : ''}</div>
            </div>` : ''}
            <div class="attribution-tooltip"><span class="title">New attribution</span><div class="content">${newAttributionRaw}</div></div>
          </td>
        </tr>
      `;
      }).join('')}
    </tbody>
  </table>
</body>
</html>`;
  return html;
}

console.log('Finding changed games...\n');

let gameFiles = getChangedGameFiles();
if (LIMIT) {
  gameFiles = gameFiles.slice(0, LIMIT);
  console.log(`Limiting to first ${LIMIT} games (--limit ${LIMIT})\n`);
}
console.log(`Processing ${gameFiles.length} game files\n`);

const games = [];

for (const gameFile of gameFiles) {
  const currentCommit = 'HEAD';
  const baseCommit = `${BASE_BRANCH}`;
  
  const oldGame = getGameFromCommit(gameFile, baseCommit);
  const newGame = getGameFromCommit(gameFile, currentCommit);
  const oldInfo = oldGame ? {
    image: oldGame._meta?.info?.image,
    attribution: oldGame._meta?.info?.attribution,
    usesAIImagery: oldGame._meta?.info?.usesAIImagery === true
  } : null;
  const newInfo = newGame ? {
    image: newGame._meta?.info?.image,
    attribution: newGame._meta?.info?.attribution,
    usesAIImagery: newGame._meta?.info?.usesAIImagery === true
  } : null;
  
  if (!oldInfo && !newInfo) continue;
  
  const gameName = path.basename(path.dirname(gameFile));
  const changes = getChangeList(oldGame, newGame);
  
  let oldImageId = null;
  let oldSize = null;
  let oldDimensions = null;
  let oldIsSquare = false;
  let oldIsAI = false;
  let oldAttribution = null;
  
  let newImageId = null;
  let newSize = null;
  let newDimensions = null;
  let newIsSquare = false;
  let newIsAI = false;
  let newAttribution = null;
  
  if (oldInfo?.image) {
    oldImageId = getImageId(oldInfo.image);
    oldSize = getImageSizeFromGit(oldInfo.image, gameFile, baseCommit);
    oldDimensions = getImageDimensionsFromGit(oldInfo.image, gameFile, baseCommit);
    oldIsSquare = oldDimensions ? oldDimensions.width === oldDimensions.height : false;
    oldIsAI = oldInfo.usesAIImagery || hasAIImagery(oldInfo.attribution);
    oldAttribution = oldInfo.attribution;
  }
  
  if (newInfo?.image) {
    newImageId = getImageId(newInfo.image);
    const newAssetPath = getImageAssetPath(newInfo.image, gameFile);
    newSize = getImageSize(newAssetPath);
    newDimensions = getImageDimensions(newAssetPath);
    newIsSquare = newDimensions ? newDimensions.width === newDimensions.height : false;
    newIsAI = newInfo.usesAIImagery || hasAIImagery(newInfo.attribution);
    newAttribution = newInfo.attribution;
  }
  
  games.push({
    name: gameName,
    changes,
    oldImageId,
    oldSize,
    oldDimensions,
    oldIsSquare,
    oldIsAI,
    oldAttribution,
    newImageId,
    newSize,
    newDimensions,
    newIsSquare,
    newIsAI,
    newAttribution
  });
  
  console.log(`Processed: ${gameName}`);
}

console.log(`\nGenerating HTML for ${games.length} games...\n`);

let baseCommit = null;
let headCommit = null;
try {
  baseCommit = execSync(`git rev-parse ${BASE_BRANCH}`, { encoding: 'utf8' }).trim();
  headCommit = execSync('git rev-parse HEAD', { encoding: 'utf8' }).trim();
} catch (e) {
  console.warn('Could not resolve commit SHAs:', e.message);
}

const html = generateHTML(games, { baseCommit, headCommit });
const outputPath = path.join(__dirname, 'image-comparison.html');
fs.writeFileSync(outputPath, html, 'utf8');

console.log(`HTML file generated: ${outputPath}`);
console.log(`Open it in your browser to view the comparison table.`);
